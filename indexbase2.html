<!DOCTYPE HTML>
<html>

<head>
	<h2>Remote control turtles!!</h2>
	<script>
		var numTurtles = 0;
		var connectedTurtles = [];
		var turtlenames = [];
		var forceNames = false;
		var curid = "all";

		ws = new WebSocket("ws://{ipAddr}:8837");
		ws.onopen = function () {
			document.getElementById("status").innerHTML = "Connected!!";
			startup();
		};
		ws.onerror = function (error) {
			console.log('WebSocket error: ' + error);
		};

		function startup() {
			ws.send("connect:browser");
			setonmessage();
		}

		function setonmessage() {
			ws.onmessage = function (event) {
				var msg = event.data.split(":");
				//console.log(msg);
				if (msg[0] == "connection") {
					if (msg[1] = "turtle") {
						connectedTurtles[parseInt(msg[2])] = true;
						console.log("adding turtle" + msg[2])
						setcurrentturtle();
						document.getElementById("selectTurtle").innerHTML = document.getElementById("selectTurtle").innerHTML + "<option value=\"" + msg[2] + "\">turtle" + msg[2] + "</option>";
						numTurtles++;
						turtlenames[parseInt(msg[2])] = "turtle" + msg[2];

						if (forceNames) {
							luaCmdSpecific(msg[2], "os.setComputerLabel('turtle" + msg[2] + "')", "false");
							luaCmdSpecific(msg[2], "os.getComputerLabel()", "os.getComputerLabel()");
						}
						else {
							luaCmdSpecific(msg[2], "os.getComputerLabel()", "os.getComputerLabel()");
						}
					}
				}
				else if (msg[0] == "disconnect") {
					if (msg[1] == "turtle") {
						html = document.getElementById("selectTurtle").innerHTML.replace("<option value=\"" + msg[2] + "\">" + turtlenames[msg[2]] + "</option>", "");
						document.getElementById("selectTurtle").innerHTML = html;
					}
				}
				else if (msg[0] == "id") {
					var id = msg[1]
					if (msg[2] == "name") {
						var name = "turtle" + id;
						if (msg[3] != "'none'") {
							if (curid == id) {
								
								document.getElementById("name").innerHTML = "<b>" + msg[3] + "</b>";
							}
							name = "\"" + msg[3] + "\"";
						}
						document.getElementById("selectTurtle").innerHTML = document.getElementById("selectTurtle").innerHTML.replace(turtlenames[parseInt(id)], name);
						turtlenames[parseInt(id)] = name;
					}
					else if (msg[2] == "return") {
						if (msg[4] == "evntNm") {
							if (curid == id) {
								if (msg[3] == "true") {
									document.getElementById("return").innerHTML = (msg[5] + " succeded!!");
								}
								else if (msg[3] == "false") {
									document.getElementById("return").innerHTML = (msg[5] + " failed.");
								}
								else {
									document.getElementById("return").innerHTML = (msg[5] + " returned: " + msg[3]);
								}
							}
						}
					}
				}
			}
		}
		function luaCmd(cmd, _eventName) {
			if (curid != "all") {
				ws.send("turtle:" + curid + ":{\"type\":\"lua\", \"cmd\":\"" + cmd + "\",\"id\":\"" + curid + "\", \"evntNm\":\"" + _eventName + "\"}");
				
			}
			else {
				for (let index = 1; index < numTurtles + 1; index++) {
					ws.send("turtle:" + index + ":{\"type\":\"lua\", \"cmd\":\"" + cmd + "\",\"id\":\"" + index + "\", \"evntNm\":\"" + _eventName + "\"}");
				}
			}
		}
		function luaCmdSpecific(id, cmd, _eventName) {
			if (id != "all") {
				ws.send("turtle:" + id + ":{\"type\":\"lua\", \"cmd\":\"" + cmd + "\",\"id\":\"" + id + "\", \"evntNm\":\"" + _eventName + "\"}");
			}
			else {
				for (let index = 1; index < numTurtles + 1; index++) {
					ws.send("turtle:" + index + ":{\"type\":\"lua\", \"cmd\":\"" + cmd + "\",\"id\":\"" + index + "\", \"evntNm\":\"" + _eventName + "\"}");
				}
			}
		}
		function setcurrentturtle() {
			curid = document.getElementById("selectTurtle").value;
			if (curid == "all") {
				document.getElementById("name").innerHTML = "<b>All</b>";
			}
			else {
				var name = turtlenames[parseInt(curid)];
				if (name.includes("\"")) {
				document.getElementById("name").innerHTML = "<b>" + name.split("\"")[1] + "</b>";
				}
				else {
					document.getElementById("name").innerHTML = "<b>" + name + "</b>";
				}
			}
		}
		function setForceNames(value) {
			var cururl = window.location.href;
			if (cururl.includes("?forceNames=false")) {
				window.location.replace(cururl.replace("?forceNames=false", "?forceNames=" + value.toString()));
			}
			else if (cururl.includes("?forceNames=true")) {
				window.location.replace(cururl.replace("?forceNames=true", "?forceNames=" + value.toString()));
			}
			else {
				window.location.replace(cururl + "?forceNames=" + value.toString());
			}
		}
	</script>
</head>

<body>
	<label for="turtles">Choose a turtle:</label>
	<select onchange="setcurrentturtle()" name="turtles" , id="selectTurtle">
		<option value="all">All</option>
	</select>
	&nbsp &nbsp
	<label for="forceNames">Force names: </label>
	<input type="checkbox", onchange="forceNames = this.checked; setForceNames(this.checked);" , name="forceNames"></input>
	<div id="status">Connecting...</div>
	<br>
	<div id="name"><b>All</b></div>
	<div id="return">Return goes here.</div>
	<p style="margin-left: 20px">
		<input type="button" , id="forward" value="Move forward" , onclick="luaCmd('turtle.forward()', 'Move forward')">
		<input type="button" , id="up" value="Move up" , onclick="luaCmd('turtle.up()', 'Move up')">
	</p>
	<input type="button" , id="turnLeft" value="Turn left" , onclick="luaCmd('turtle.turnLeft()', 'Turn left')">
	<input type="button" , id="turnRight" value="Turn right" , onclick="luaCmd('turtle.turnRight()', 'Turn right')">
	<p style="margin-left: 15px">
		<input type="button" , id="back" value="Move backward" , onclick="luaCmd('turtle.back()', 'Move backward')">
		<input type="button" , id="down" value="Move down" , onclick="luaCmd('turtle.down()', 'Move down')">
	</p>
	<input type="text" , id="cmd" , value="turtle.dig()"></input>
	<input type="button" , value="Execute code", onclick="luaCmd(document.getElementById('cmd').value, document.getElementById('cmd').value)"></input>
	<br>
	<input type="text", id="setNm", value="turtle"></input>
	<input type="button", value="Set name", onclick="if (!forceNames && curid != 'all') {luaCmd('os.setComputerLabel(\'' + document.getElementById('setNm').value + '\')', 'os.setComputerLabel(\'' + document.getElementById('setNm').value + '\')'); luaCmd('os.getComputerLabel()', 'os.getComputerLabel()'); setcurrentturtle();}"></input>

</body>

</html>